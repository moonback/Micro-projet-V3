# üöÄ Syst√®me d'Acceptation des T√¢ches - MicroTask

## üìã Vue d'ensemble

Le syst√®me d'acceptation des t√¢ches a √©t√© compl√®tement refactoris√© pour offrir un workflow professionnel et s√©curis√©. Au lieu d'une acceptation directe, les utilisateurs postulent maintenant pour les t√¢ches, et les propri√©taires peuvent choisir parmi plusieurs candidats.

## üîÑ Nouveau Workflow

### **Ancien Syst√®me (Simple)**
```
T√¢che ouverte ‚Üí Aide accepte directement ‚Üí T√¢che assign√©e
```

### **Nouveau Syst√®me (Professionnel)**
```
T√¢che ouverte ‚Üí Aides candidatent ‚Üí Propri√©taire choisit ‚Üí Validation ‚Üí D√©marrage
```

## üèóÔ∏è Architecture Technique

### **1. Nouvelle Table : `task_applications`**
```sql
CREATE TABLE task_applications (
  id UUID PRIMARY KEY,
  task_id UUID REFERENCES tasks(id),
  helper_id UUID REFERENCES profiles(id),
  status TEXT CHECK (status IN ('pending', 'accepted', 'rejected', 'withdrawn')),
  message TEXT, -- Message de motivation
  proposed_budget NUMERIC(10,2), -- Budget propos√©
  proposed_duration INTERVAL, -- Dur√©e propos√©e
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ,
  accepted_at TIMESTAMPTZ,
  rejected_at TIMESTAMPTZ,
  withdrawn_at TIMESTAMPTZ
);
```

### **2. Nouveaux Statuts de T√¢ches**
- **`open`** : T√¢che ouverte aux candidatures
- **`pending_approval`** : Candidature accept√©e, en attente de validation
- **`assigned`** : T√¢che assign√©e (maintenu pour compatibilit√©)
- **`in_progress`** : T√¢che en cours
- **`completed`** : T√¢che termin√©e
- **`cancelled`** : T√¢che annul√©e
- **`expired`** : T√¢che expir√©e

### **3. Fonctions PostgreSQL**
- **`accept_application(application_id)`** : Accepter une candidature
- **`approve_task_start(task_id)`** : Valider le d√©marrage
- **`reject_task_start(task_id)`** : Rejeter et remettre en open
- **`count_active_applications(task_id)`** : Compter les candidatures actives

## üéØ Fonctionnalit√©s Impl√©ment√©es

### **‚úÖ Pour les Aides (Helpers)**
- **Candidature** : Postuler avec message de motivation
- **Propositions** : Budget et dur√©e personnalis√©s
- **Suivi** : Voir le statut de sa candidature
- **Retrait** : Retirer sa candidature si n√©cessaire

### **‚úÖ Pour les Propri√©taires (Authors)**
- **Gestion des candidatures** : Voir toutes les candidatures
- **S√©lection** : Choisir le meilleur candidat
- **Validation** : Approuver le d√©marrage de la t√¢che
- **Rejet** : Refuser et remettre en open si n√©cessaire

### **‚úÖ Interface Utilisateur**
- **Composant TaskApplications** : Gestion compl√®te des candidatures
- **Composant TaskHistory** : Historique d√©taill√© des t√¢ches
- **Filtres avanc√©s** : Recherche et tri des candidatures
- **Notifications** : Feedback en temps r√©el

## üöÄ Utilisation

### **1. Candidater √† une T√¢che**

#### **√âtape 1 : Voir la T√¢che**
- Naviguer vers une t√¢che ouverte
- Cliquer sur le bouton "Candidater"

#### **√âtape 2 : Remplir le Formulaire**
```typescript
interface ApplicationFormData {
  message: string           // Message de motivation obligatoire
  proposed_budget?: number  // Budget propos√© (optionnel)
  proposed_duration?: string // Dur√©e propos√©e (optionnel)
}
```

#### **√âtape 3 : Envoi**
- Validation automatique des donn√©es
- Cr√©ation de la candidature en base
- Notification de succ√®s

### **2. G√©rer les Candidatures (Propri√©taire)**

#### **√âtape 1 : Voir les Candidatures**
- Acc√©der √† la page des candidatures de sa t√¢che
- Voir toutes les candidatures avec statuts

#### **√âtape 2 : √âvaluer les Candidats**
- **Profil** : Nom, avatar, note, exp√©rience
- **Message** : Motivation et approche
- **Propositions** : Budget et dur√©e personnalis√©s
- **Historique** : T√¢ches pr√©c√©dentes

#### **√âtape 3 : Accepter une Candidature**
- Cliquer sur "Accepter"
- Confirmation avec modal
- Statut de la t√¢che ‚Üí `pending_approval`
- Autres candidatures automatiquement rejet√©es

### **3. Valider le D√©marrage**

#### **√âtape 1 : V√©rification**
- T√¢che en statut `pending_approval`
- Candidature accept√©e
- Aide assign√©

#### **√âtape 2 : Validation**
- Cliquer sur "Valider le d√©marrage"
- Statut de la t√¢che ‚Üí `in_progress`
- Timestamp `started_at` mis √† jour

#### **√âtape 3 : Alternative - Rejet**
- Cliquer sur "Rejeter"
- T√¢che remise en statut `open`
- Aide d√©sassign√©
- Possibilit√© de nouvelles candidatures

## üì± Composants React

### **TaskApplications.tsx**
```typescript
interface TaskApplicationsProps {
  taskId: string
  taskTitle: string
  taskStatus: string
  isAuthor: boolean
  onStatusChange?: () => void
}
```

**Fonctionnalit√©s :**
- Affichage des candidatures
- Formulaire de candidature
- Gestion des statuts
- Actions (accepter, rejeter, retirer)

### **TaskHistory.tsx**
```typescript
interface TaskHistoryProps {
  onTaskPress?: (task: TaskHistoryItem) => void
  showApplications?: boolean
}
```

**Fonctionnalit√©s :**
- Historique complet des t√¢ches
- Filtres avanc√©s (statut, cat√©gorie, date)
- Statistiques d√©taill√©es
- Navigation vers les d√©tails

## üîß Hooks Personnalis√©s

### **useTaskApplications**
```typescript
const {
  applications,           // Liste des candidatures
  loading,               // √âtat de chargement
  error,                 // Erreurs √©ventuelles
  createApplication,     // Cr√©er une candidature
  acceptApplication,     // Accepter une candidature
  rejectApplication,     // Rejeter une candidature
  withdrawApplication,   // Retirer sa candidature
  approveTaskStart,      // Valider le d√©marrage
  rejectTaskStart,       // Rejeter le d√©marrage
  updateFilters,         // Mettre √† jour les filtres
  resetFilters           // R√©initialiser les filtres
} = useTaskApplications(taskId)
```

## üóÑÔ∏è Base de Donn√©es

### **Vues Cr√©√©es**

#### **task_applications_with_profiles**
```sql
SELECT 
  ta.*,
  t.title as task_title,
  t.status as task_status,
  p.name as helper_name,
  p.avatar_url as helper_avatar,
  p.rating as helper_rating
FROM task_applications ta
JOIN tasks t ON ta.task_id = t.id
JOIN profiles p ON ta.helper_id = p.id
```

#### **task_history**
```sql
SELECT 
  t.*,
  p.name as author_name,
  helper_p.name as helper_name,
  COUNT(ta.id) as total_applications,
  COUNT(CASE WHEN ta.status = 'accepted' THEN 1 END) as accepted_applications
FROM tasks t
LEFT JOIN profiles p ON t.author = p.id
LEFT JOIN profiles helper_p ON t.helper = helper_p.id
LEFT JOIN task_applications ta ON t.id = ta.task_id
GROUP BY t.id, p.name, helper_p.name
```

### **Politiques RLS (Row Level Security)**

#### **Lecture des Candidatures**
- **Auteur de la t√¢che** : Voir toutes les candidatures
- **Candidats** : Voir leurs propres candidatures
- **Autres utilisateurs** : Pas d'acc√®s

#### **Cr√©ation de Candidatures**
- **Utilisateur authentifi√©** : Peut candidater
- **Auteur de la t√¢che** : Ne peut pas candidater √† sa propre t√¢che
- **Candidature unique** : Un seul candidat par t√¢che

#### **Gestion des Candidatures**
- **Auteur de la t√¢che** : Accepter/rejeter
- **Candidat** : Modifier/retirer sa candidature
- **Contraintes** : Statuts autoris√©s selon le r√¥le

## üß™ Tests et Validation

### **Tests Automatiques**
```bash
# Ex√©cuter le fichier de test SQL
# test-task-acceptance-system.sql
```

### **Tests Manuels**
1. **Cr√©er une t√¢che** avec un compte utilisateur
2. **Candidater** avec un autre compte
3. **Accepter la candidature** avec le premier compte
4. **Valider le d√©marrage** et v√©rifier le statut
5. **Tester le rejet** et la remise en open

### **Validation des Fonctionnalit√©s**
- ‚úÖ Candidatures multiples
- ‚úÖ Gestion des statuts
- ‚úÖ Workflow de validation
- ‚úÖ Politiques de s√©curit√©
- ‚úÖ Interface utilisateur
- ‚úÖ Notifications

## üö® Gestion des Erreurs

### **Erreurs Courantes**

#### **Candidature Dupliqu√©e**
```sql
-- Contrainte unique sur (task_id, helper_id)
UNIQUE(task_id, helper_id)
```

#### **Statut Invalide**
```sql
-- V√©rification des transitions de statut
CHECK (status IN ('pending', 'accepted', 'rejected', 'withdrawn'))
```

#### **Permissions Insuffisantes**
- Politiques RLS actives
- V√©rification des r√¥les utilisateur
- Logs d'audit des actions

### **R√©cup√©ration d'Erreur**
- **Rollback automatique** des transactions
- **Messages d'erreur** explicites
- **Interface de retry** pour les actions √©chou√©es
- **Logs d√©taill√©s** pour le d√©bogage

## üìä M√©triques et Analytics

### **Donn√©es Collect√©es**
- **Nombre de candidatures** par t√¢che
- **Taux d'acceptation** des candidatures
- **Temps de r√©ponse** des propri√©taires
- **Qualit√© des candidatures** (message, propositions)

### **Tableau de Bord**
- **Statistiques globales** : Total, accept√©es, rejet√©es
- **Performance par cat√©gorie** : T√¢ches populaires
- **Tendances temporelles** : √âvolution des candidatures
- **Utilisateurs actifs** : Top candidats et propri√©taires

## üîÆ √âvolutions Futures

### **Fonctionnalit√©s Planifi√©es**
- **Syst√®me de notation** des candidatures
- **Notifications push** pour les mises √† jour
- **Chat int√©gr√©** entre candidat et propri√©taire
- **Syst√®me de recommandations** bas√© sur l'historique

### **Am√©liorations Techniques**
- **Cache Redis** pour les candidatures fr√©quentes
- **Webhooks** pour les int√©grations externes
- **API GraphQL** pour les requ√™tes complexes
- **Tests automatis√©s** complets

## üìã Checklist de D√©ploiement

### **Base de Donn√©es**
- [ ] Migration appliqu√©e sans erreur
- [ ] Table `task_applications` cr√©√©e
- [ ] Vues cr√©√©es et fonctionnelles
- [ ] Fonctions PostgreSQL cr√©√©es
- [ ] Politiques RLS configur√©es
- [ ] Index cr√©√©s pour les performances

### **Frontend**
- [ ] Composant `TaskApplications` int√©gr√©
- [ ] Composant `TaskHistory` int√©gr√©
- [ ] Hook `useTaskApplications` fonctionnel
- [ ] Types TypeScript mis √† jour
- [ ] Interface utilisateur test√©e

### **Tests**
- [ ] Tests SQL ex√©cut√©s
- [ ] Tests manuels effectu√©s
- [ ] Workflow complet valid√©
- [ ] Gestion d'erreurs test√©e
- [ ] Performance v√©rifi√©e

## üéâ Conclusion

Le nouveau syst√®me d'acceptation des t√¢ches transforme MicroTask en une plateforme professionnelle avec :

‚úÖ **Workflow s√©curis√©** : Candidatures ‚Üí S√©lection ‚Üí Validation  
‚úÖ **Gestion des candidatures** : Messages, propositions, statuts  
‚úÖ **Interface utilisateur** : Composants React modernes et intuitifs  
‚úÖ **Base de donn√©es** : Architecture robuste avec vues et fonctions  
‚úÖ **S√©curit√©** : Politiques RLS et validation des donn√©es  
‚úÖ **Performance** : Index optimis√©s et requ√™tes efficaces  

**Le syst√®me est maintenant pr√™t pour la production ! üöÄ**

---

*Document cr√©√© le 27 ao√ªt 2025 - Syst√®me d'Acceptation des T√¢ches MicroTask*
